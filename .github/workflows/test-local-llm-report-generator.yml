name: Test Local LLM Report Generator

on:
  workflow_dispatch:
    inputs:
      use_real_model:
        description: 'Download and use real BIST-Financial-Qwen-7B model'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
  push:
    branches: [ main, master ]
    paths:
      - 'local_llm_report_generator.py'
  pull_request:
    branches: [ main, master ]

jobs:
  test-fallback-mode:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies (without LLM)
      run: |
        pip install pandas numpy matplotlib
        pip install -r requirements.txt || echo "requirements.txt not found"
    
    - name: Create comprehensive test data
      run: |
        mkdir -p test_llm_data
        
        python -c "
        import json
        from datetime import datetime
        
        # Create realistic test data with all sections
        comprehensive_data = {
            'metadata': {
                'date': '2024-11-01',
                'event_name': 'Non-Farm Payrolls',
                'timestamp': datetime.now().isoformat(),
                'pipeline_version': '2.0',
                'symbols': ['GC', 'DX', 'ES', 'TNX']
            },
            'sections': {
                'executive_summary': {
                    'market_overview': 'Comprehensive analysis of Non-Farm Payrolls impact on gold, dollar, and equity markets',
                    'sentiment': {
                        'overall': 'BULLISH',
                        'confidence': 0.75
                    },
                    'key_findings': [
                        'Technical indicators align bullishly across all major instruments',
                        'Institutional positioning shows significant long bias in gold',
                        'Seasonal patterns favor upward movement in Q4',
                        'Economic data supports risk-on sentiment'
                    ],
                    'recommendations': [
                        'Monitor 1950 support level in gold for entry opportunities',
                        'Watch for volume confirmation on breakouts',
                        'Stay alert to DXY weakness as bullish catalyst',
                        'Consider profit-taking near 2000 resistance'
                    ]
                },
                'news': {
                    'article_count': 47,
                    'sources': ['Reuters', 'Bloomberg', 'Financial Times', 'WSJ', 'MarketWatch'],
                    'key_themes': [
                        'employment',
                        'inflation expectations',
                        'federal reserve policy',
                        'market volatility',
                        'gold demand'
                    ],
                    'sentiment': 'MIXED_BULLISH',
                    'top_headlines': [
                        'Jobs report beats expectations',
                        'Gold reaches 3-month high',
                        'Dollar weakens on rate speculation'
                    ]
                },
                'indicators': {
                    'overall_bias': 'BULLISH',
                    'buy_signals': 10,
                    'sell_signals': 3,
                    'neutral_signals': 2,
                    'symbols_analyzed': 4,
                    'strongest_signal': 'RSI Golden Cross',
                    'weakest_signal': 'Stochastic Overbought'
                },
                'cot': {
                    'net_positioning': 'LONG',
                    'positioning_change': '+15.3%',
                    'institutional_sentiment': 'BULLISH',
                    'commercials_long': 145000,
                    'commercials_short': 87000,
                    'non_commercials_long': 98000,
                    'non_commercials_short': 45000,
                    'net_contracts': 58000
                },
                'economic': {
                    'overall_status': 'MODERATE_STRONG',
                    'inflation_trend': 'RISING_MODERATELY',
                    'growth_outlook': 'STABLE_POSITIVE',
                    'unemployment_rate': 3.7,
                    'gdp_growth': 2.4,
                    'cpi_yoy': 3.2,
                    'fed_funds_rate': 5.25
                },
                'correlations': {
                    'key_relationships': {
                        'DXY_GOLD': {
                            'strength': 'STRONG',
                            'direction': 'INVERSE',
                            'correlation': -0.78
                        },
                        'SPX_GOLD': {
                            'strength': 'MODERATE',
                            'direction': 'POSITIVE',
                            'correlation': 0.45
                        },
                        'TNX_GOLD': {
                            'strength': 'MODERATE',
                            'direction': 'INVERSE',
                            'correlation': -0.52
                        }
                    },
                    'strongest_correlation': 'DXY_GOLD'
                },
                'structure': {
                    'trend': 'UPTREND',
                    'support_levels': [1950, 1925, 1900, 1875],
                    'resistance_levels': [2000, 2025, 2050, 2075],
                    'current_price': 1975,
                    'trend_strength': 'STRONG'
                },
                'seasonality': {
                    'seasonal_bias': 'BULLISH',
                    'historical_performance': '+2.8%',
                    'best_months': ['November', 'December', 'January'],
                    'current_month_avg': '+1.9%',
                    'win_rate': 68
                },
                'volume': {
                    'volume_trend': 'INCREASING',
                    'volume_profile': 'ACCUMULATION',
                    'avg_volume_20d': 125000,
                    'current_volume': 145000,
                    'volume_change': '+16%'
                },
                'hf_methods': {
                    'sentiment_score': 0.68,
                    'forecast_direction': 'UP',
                    'forecast_confidence': 0.72,
                    'anomalies_detected': 0,
                    'pattern_recognition': 'BULLISH_CONTINUATION',
                    'ai_recommendation': 'BUY'
                },
                'synthesis': {
                    'overall_outlook': 'BULLISH',
                    'confidence': 0.76,
                    'key_factors': [
                        'Technical indicators showing strong momentum',
                        'Institutional positioning heavily bullish',
                        'Seasonal patterns historically favorable',
                        'Economic backdrop moderately supportive',
                        'Negative correlation with weakening dollar'
                    ],
                    'risks': [
                        'Potential overbought conditions short-term',
                        'Economic data volatility',
                        'Geopolitical uncertainties',
                        'Fed policy surprises'
                    ],
                    'trade_ideas': [
                        'Long gold above 1950 with stop at 1925',
                        'Target 2000-2025 for initial profit taking',
                        'Consider scaling in on pullbacks to support'
                    ]
                }
            }
        }
        
        with open('test_llm_data/comprehensive_test.json', 'w') as f:
            json.dump(comprehensive_data, f, indent=2)
        
        print('✓ Comprehensive test data created')
        print(f'✓ Data size: {len(json.dumps(comprehensive_data))} characters')
        "
    
    - name: Test report generation (fallback mode)
      run: |
        python local_llm_report_generator.py test_llm_data/comprehensive_test.json
    
    - name: Verify HTML report
      run: |
        HTML_FILE=$(find test_llm_data -name "*_ai_report.html" -type f | head -1)
        
        if [ -z "$HTML_FILE" ]; then
          echo "❌ HTML report not generated"
          exit 1
        fi
        
        echo "✓ HTML report generated: $HTML_FILE"
        
        # Verify content
        echo ""
        echo "Checking report content..."
        
        grep -q "AI Insights" "$HTML_FILE" && echo "✓ Contains AI Insights sections"
        grep -q "Bootstrap" "$HTML_FILE" && echo "✓ Contains Bootstrap styling"
        grep -q "Chart.js" "$HTML_FILE" && echo "✓ Contains Chart.js"
        grep -q "Executive Summary" "$HTML_FILE" && echo "✓ Contains Executive Summary"
        grep -q "BULLISH" "$HTML_FILE" && echo "✓ Contains market outlook"
        grep -q "accordion" "$HTML_FILE" && echo "✓ Contains raw data accordions"
        
        # Count sections
        SECTION_COUNT=$(grep -c 'class="section card' "$HTML_FILE" || echo 0)
        echo "✓ Sections found: $SECTION_COUNT"
        
        if [ $SECTION_COUNT -lt 8 ]; then
          echo "⚠️  Warning: Expected at least 8 sections, found $SECTION_COUNT"
        fi
        
        # Check file size
        SIZE=$(stat -c%s "$HTML_FILE")
        echo "✓ File size: $SIZE bytes ($(echo "scale=2; $SIZE/1024" | bc) KB)"
        
        if [ $SIZE -lt 10000 ]; then
          echo "⚠️  Warning: HTML file seems small"
        fi
    
    - name: Test with minimal data
      run: |
        python -c "
        import json
        
        minimal_data = {
            'metadata': {'date': '2024-11-01', 'event_name': 'Minimal Test'},
            'sections': {
                'executive_summary': {
                    'sentiment': {'overall': 'NEUTRAL', 'confidence': 0.5}
                }
            }
        }
        
        with open('test_llm_data/minimal_test.json', 'w') as f:
            json.dump(minimal_data, f, indent=2)
        "
        
        python local_llm_report_generator.py test_llm_data/minimal_test.json
        
        if [ -f test_llm_data/minimal_test_ai_report.html ]; then
          echo "✓ Minimal data test passed"
        fi
    
    - name: Upload fallback mode artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: llm-fallback-mode-test-${{ github.run_number }}
        path: test_llm_data/
        retention-days: 14

  test-with-real-model:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    if: github.event.inputs.use_real_model == 'true'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install llama-cpp-python
      run: |
        pip install llama-cpp-python
        pip install pandas numpy matplotlib
        pip install -r requirements.txt || echo "requirements.txt not found"
    
    - name: Create test data
      run: |
        mkdir -p test_real_llm
        
        python -c "
        import json
        
        test_data = {
            'metadata': {'date': '2024-11-01', 'event_name': 'Real LLM Test'},
            'sections': {
                'executive_summary': {
                    'sentiment': {'overall': 'BULLISH', 'confidence': 0.75}
                },
                'indicators': {
                    'overall_bias': 'BULLISH',
                    'buy_signals': 8,
                    'sell_signals': 3
                },
                'news': {
                    'article_count': 25,
                    'key_themes': ['employment', 'inflation', 'growth'],
                    'sentiment': 'POSITIVE'
                }
            }
        }
        
        with open('test_real_llm/test_data.json', 'w') as f:
            json.dump(test_data, f, indent=2)
        "
    
    - name: Test with real BIST-Financial-Qwen-7B model
      run: |
        echo "⚠️  This will download ~4GB model..."
        python local_llm_report_generator.py test_real_llm/test_data.json
    
    - name: Verify real model output
      run: |
        HTML_FILE=$(find test_real_llm -name "*_ai_report.html" -type f | head -1)
        
        if [ -n "$HTML_FILE" ]; then
          echo "✓ Real LLM report generated"
          
          # Check for actual LLM-generated content
          if grep -q "Analyze this" "$HTML_FILE"; then
            echo "⚠️  Contains fallback content"
          else
            echo "✓ Contains LLM-generated insights"
          fi
        fi
    
    - name: Upload real model artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: llm-real-model-test-${{ github.run_number }}
        path: test_real_llm/
        retention-days: 14

  test-html-quality:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install beautifulsoup4 lxml
        pip install pandas numpy
    
    - name: Create test data
      run: |
        mkdir -p quality_test
        
        python -c "
        import json
        
        data = {
            'metadata': {'date': '2024-11-01', 'event_name': 'Quality Test'},
            'sections': {
                'executive_summary': {'sentiment': {'overall': 'BULLISH'}},
                'news': {'article_count': 15, 'key_themes': ['test']},
                'indicators': {'buy_signals': 8, 'sell_signals': 3}
            }
        }
        
        with open('quality_test/data.json', 'w') as f:
            json.dump(data, f, indent=2)
        "
    
    - name: Generate report
      run: |
        python local_llm_report_generator.py quality_test/data.json
    
    - name: Validate HTML quality
      run: |
        HTML_FILE=$(find quality_test -name "*.html" -type f | head -1)
        
        python -c "
        from bs4 import BeautifulSoup
        import sys
        
        html_file = '$HTML_FILE'
        
        with open(html_file, 'r') as f:
            soup = BeautifulSoup(f, 'html.parser')
        
        print('HTML Quality Checks:')
        print('=' * 50)
        
        # Check structure
        if soup.find('html'):
            print('✓ Valid HTML structure')
        else:
            print('❌ Invalid HTML structure')
            sys.exit(1)
        
        # Check head elements
        if soup.find('head'):
            print('✓ Has <head> section')
        if soup.find('title'):
            print('✓ Has <title>')
        if soup.find('meta', {'charset': True}):
            print('✓ Has charset meta tag')
        
        # Check body
        if soup.find('body'):
            print('✓ Has <body> section')
        
        # Check Bootstrap
        bootstrap_links = soup.find_all('link', {'href': lambda x: x and 'bootstrap' in x})
        if bootstrap_links:
            print(f'✓ Has Bootstrap CSS ({len(bootstrap_links)} links)')
        
        # Check Chart.js
        chart_scripts = soup.find_all('script', {'src': lambda x: x and 'chart.js' in x})
        if chart_scripts:
            print(f'✓ Has Chart.js ({len(chart_scripts)} scripts)')
        
        # Check sections
        sections = soup.find_all(class_='section')
        print(f'✓ Found {len(sections)} sections')
        
        # Check for AI insights
        ai_insights = soup.find_all(text=lambda x: x and 'AI Insights' in x)
        print(f'✓ Found {len(ai_insights)} AI Insight sections')
        
        # Check for accordions (raw data)
        accordions = soup.find_all(class_='accordion')
        print(f'✓ Found {len(accordions)} data accordions')
        
        # Check navigation
        nav = soup.find('nav')
        if nav:
            print('✓ Has navigation menu')
        
        print('=' * 50)
        print('✓ All quality checks passed')
        "
    
    - name: Upload quality test artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: llm-quality-test-${{ github.run_number }}
        path: quality_test/
        retention-days: 7

  test-performance:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install pandas numpy
    
    - name: Performance test
      run: |
        mkdir -p perf_test
        
        # Create large dataset
        python -c "
        import json
        import time
        
        # Large comprehensive data
        data = {
            'metadata': {'date': '2024-11-01', 'event_name': 'Performance Test'},
            'sections': {}
        }
        
        # Add many sections
        for i in range(20):
            data['sections'][f'section_{i}'] = {
                'value': i,
                'data': list(range(100)),
                'metadata': {'test': True}
            }
        
        with open('perf_test/large_data.json', 'w') as f:
            json.dump(data, f, indent=2)
        
        print(f'Created test data: {len(json.dumps(data))} characters')
        "
        
        # Time the generation
        START=$(date +%s)
        python local_llm_report_generator.py perf_test/large_data.json
        END=$(date +%s)
        
        DURATION=$((END - START))
        echo ""
        echo "Performance Results:"
        echo "  Generation time: ${DURATION}s"
        
        if [ $DURATION -lt 30 ]; then
          echo "✓ Performance acceptable (<30s)"
        else
          echo "⚠️  Performance slower than expected (${DURATION}s)"
        fi
    
    - name: Upload performance test artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: llm-performance-test-${{ github.run_number }}
        path: perf_test/
        retention-days: 7

  display-summary:
    runs-on: ubuntu-latest
    needs: [test-fallback-mode, test-html-quality, test-performance]
    if: always()
    
    steps:
    - name: Display test summary
      run: |
        echo "=========================================="
        echo "LOCAL LLM REPORT GENERATOR TEST SUMMARY"
        echo "=========================================="
        echo ""
        echo "Test Results:"
        echo "- Fallback Mode: ${{ needs.test-fallback-mode.result }}"
        echo "- HTML Quality: ${{ needs.test-html-quality.result }}"
        echo "- Performance: ${{ needs.test-performance.result }}"
        echo ""
        echo "Features Tested:"
        echo "  ✓ Fallback mode (without LLM)"
        echo "  ✓ Comprehensive data handling"
        echo "  ✓ HTML report generation"
        echo "  ✓ Bootstrap 5 styling"
        echo "  ✓ Chart.js integration"
        echo "  ✓ Section rendering"
        echo "  ✓ AI insights generation"
        echo "  ✓ Raw data accordions"
        echo "  ✓ Performance benchmarking"
        echo ""
        echo "All test artifacts available in Actions > Artifacts"
        echo "=========================================="
